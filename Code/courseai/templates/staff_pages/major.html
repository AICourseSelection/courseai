{% extends 'staff_pages/staff_base.html' %}
{% block content %}
    <section id="bc" class="mt-3">
    <div class="container">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
              <a href="{% url 'index' %}">
            <i class="fa fa-home"></i> Home </a>
          </li>
            <li class="breadcrumb-item active">{{ bc_param }}</li>
        </ol>
      </nav>
    </div>
  </section>
    <div class="container text-center">
        <h1 class="display-4 mb-4">
            Search Major
        </h1>

        <div class="form-row">
            <div class="col-md-4 mb-3">

            </div>

            <div class="col-md-4 mb-3">
                <label class="sr-only">Year</label>

            </div>
            <div class="col-md-4 mb-3">

            </div>

        </div>
    </div>
    <div class="container">
        <div class="row justify-content-md-center">
            <div class="col col-lg-4">
                <input type="text" id="search" name="search" class="form-control" placeholder="Major Code ">
            </div>
            <div class="col-md-auto">
                <select id="year" name='year' class="form-control">
                    {% for year in years %}
                        {% if year == year_now %}
                            <option selected value="{{ year }}">{{ year }}</option>
                        {% else %}
                            <option value="{{ year }}">{{ year }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            <div class="col col-lg-2">
                <button onclick="showMajors()" class="btn btn-outline-primary">Search</button>
        </div>
        </div>
    </div>
    <div style="width: 100%; text-align: center">
        <div>&nbsp</div>
        <div class="table-responsive">
            <table id="Table" class="table table-hover" style="width: 65%; margin: auto">

            </table>
        </div>
    </div>
    <script>
    function str_substr(start, end, str) {
        content = [];
       try{
            temp = str.split(start, 2);
            content = temp[1].split(end, 2);
        }
        catch (e) {
            console.log(e.name + ":" + e.message);
        }
        if(content==undefined){
            return null;
        }
        return content[0];
    }
        let level="undergraduate";
        let description="";
    var majorsCodes = [];
    var majorsVersions = [];


     function showMajors() {
         majorsCodes = [];
         majorsVersions = [];
        let majors = document.getElementById("search").value;
        //let level = document.getElementById("level").value;
         let year =document.getElementById("year").value;
        let tableData = "<tr>";
        const majorDescription = [];
        const majorsTitle = [];
        $.ajax({
            url: '../search/majors',
            data: {"query": majors, "level": level},
            success: function (data) {
                let i;
                for (i in data.responses) {
                    if (data.responses[i].versions[year] != undefined) {
                        if (data.responses[i].versions[year].description != undefined) {
                            majorsCodes.push(data.responses[i].code);
                            majorsVersions.push(JSON.stringify(data.responses[i].versions));
                            description=JSON.stringify(data.responses[i].versions[year].description);
                            description=str_substr("\"",".",description);
                            majorDescription.push(description+"......");
                            majorsTitle.push(JSON.stringify(data.responses[i].versions[year].title).replace(/\"/g,""));
                        }
                    }
                }
                if (majorsCodes.length == 0) {
                    tableData += "<th>" + "No such major" + "</th>" + "</tr>";
                } else {
                    for (i = 0; i < majorsCodes.length + 1; i++) {
                        for (let j = 0; j < 3; j++) {
                            if (i == 0) {
                                if (j == 0) {
                                    tableData += "<th>" + "Major Code" + "</th>";
                                } else if (j == 1) {
                                    tableData += "<th>" + "Major Title" + "</th>";
                                } else if (j == 2) {
                                    tableData += "<th>" + "Major Description" + "</th>";
                                }
                            } else {
                                if (j == 0) {
                                    tableData += "<td>" +
                                        "<a href=\"major_detail?code=" + majorsCodes[i - 1] + "&year=" + year + "\" onClick=\"saveData('" + (i - 1) + "')\">" +
                                        majorsCodes[i - 1] +
                                        "</a>" +
                                        "</td>";
                                } else if (j == 2) {
                                    tableData += "<td>" +
                                        "<a href=\"major_detail?code=" + majorsCodes[i - 1] + "&year=" + year + "\" onClick=\"saveData('" + (i - 1) + "')\">" +
                                        majorDescription[i - 1] +
                                        "</a>" +
                                        "</td>";
                                } else if (j == 1) {
                                    tableData += "<td>" +
                                        "<a href=\"major_detail?code=" + majorsCodes[i - 1] + "&year=" + year + "\" onClick=\"saveData('" + (i - 1) + "')\">" +
                                        majorsTitle[i - 1] +
                                        "</a>" +
                                        "</td>";
                                }
                            }
                        }
                        tableData += "</tr>" + "<tr>";
                    }
                }
                $("#Table").html(tableData);
            }
        });
    }

    function saveData(i) {
        //alert("success");
        sessionStorage.setItem("majorVersion", majorsVersions[i]);
        sessionStorage.setItem("majorCode", majorsCodes[i]);
    }

    </script>
{% endblock %}