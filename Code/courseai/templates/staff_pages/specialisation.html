{% extends 'staff_pages/staff_base.html' %}
{% block content %}
    <section id="bc" class="mt-3">
    <div class="container">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
              <a href="{% url 'index' %}">
            <i class="fa fa-home"></i> Home </a>
          </li>
            <li class="breadcrumb-item active">{{ bc_param }}</li>
        </ol>
      </nav>
    </div>
  </section>
    <div class="container text-center">
        <h1 class="display-4 mb-4">
            Search Specialisation
        </h1>

        <div class="form-row">
            <div class="col-md-4 mb-3">

            </div>

            <div class="col-md-4 mb-3">
                <label class="sr-only">Year</label>

            </div>
            <div class="col-md-4 mb-3">

            </div>

        </div>

    </div>
    <div class="container">
        <div class="row justify-content-md-center">
            <div class="col col-lg-4">
                <input type="text" id="search" name="search" class="form-control" placeholder="Specialisation Code ">
            </div>
            <div class="col-md-auto">
                <select id="year" name='year' class="form-control">
                    {% for year in years %}
                        {% if year == year_now %}
                            <option selected value="{{ year }}">{{ year }}</option>
                        {% else %}
                            <option value="{{ year }}">{{ year }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            <div class="col col-lg-2">
                <button onclick="showSpecs()" class="btn btn-outline-primary">Search</button>
        </div>
        </div>

        <div style="width: 100%; text-align: center">
            <div>&nbsp</div>
            <div class="table-responsive">
                <table id="Table" class="table table-hover" style="width: 65%; margin: auto">

                </table>
            </div>
        </div>
    </div>
    <script>
        function str_substr(start, end, str) {
            content = [];
            try {
                temp = str.split(start, 2);
                content = temp[1].split(end, 2);
            } catch (e) {
                console.log(e.name + ":" + e.message);
            }
            return content[0];
        }

        let level = "undergraduate";
        let description = "";
        var specCodes = [];
        var specVersion = [];

        function showSpecs() {
            specCodes = [];
            specVersion = [];
            let specs = document.getElementById("search").value;
            let year = document.getElementById("year").value;
            //let level = document.getElementById("level").value;
            let tableData = "<tr>";
            const specDescription = [];
            const specsTitle = [];
            $.ajax({
                url: '../search/specs',
                data: {"query": specs, "level": level},
                success: function (data) {
                    for (i in data.responses) {

                        if (data.responses[i].versions[year] != undefined) {
                            description = JSON.stringify(data.responses[i].versions[year].description);
                            if (description != undefined) {
                                specCodes.push(data.responses[i].code);
                                specVersion.push(JSON.stringify(data.responses[i].versions));
                                description = str_substr("\"", ".", description);
                                specDescription.push(description + ".......");
                                specsTitle.push(JSON.stringify(data.responses[i].versions[year].title).replace(/\"/g, ""));

                            }

                        }
                    }
                    if (specCodes.length == 0) {
                        tableData += "<th>" + "No such spec" + "</th>" + "</tr>";
                    } else {
                        for (var i = 0; i < specCodes.length + 1; i++) {
                            for (var j = 0; j < 3; j++) {
                                if (i == 0) {
                                    if (j == 0) {
                                        tableData += "<th>" + "spec Code" + "</th>";
                                    } else if (j == 1) {
                                        tableData += "<th>" + "spec Title" + "</th>";
                                    } else if (j == 2) {
                                        tableData += "<th>" + "spec Description" + "</th>";
                                    }
                                } else {
                                    if (j == 0) {
                                        tableData += "<td>" +
                                            "<a href=\"specialisation_detail?code=" + specCodes[i - 1] + "&year=" + year + "\" onClick=\"saveData('" + (i - 1) + "')\">" +
                                            specCodes[i - 1] +
                                            "</a>" +
                                            "</td>";
                                    } else if (j == 2) {
                                        tableData += "<td>" +
                                            "<a href=\"specialisation_detail?code=" + specCodes[i - 1] + "&year=" + year + "\" onClick=\"saveData('" + (i - 1) + "')\">" +
                                            specDescription[i - 1] +
                                            "</a>" +
                                            "</td>";
                                    } else if (j == 1) {
                                        tableData += "<td>" +
                                            "<a href=\"specialisation_detail?code=" + specCodes[i - 1] + "&year=" + year + "\" onClick=\"saveData('" + (i - 1) + "')\">" +
                                            specsTitle[i - 1] +
                                            "</a>" +
                                            "</td>";
                                    }
                                }
                            }
                            tableData += "</tr>" + "<tr>";
                        }
                    }
                    $("#Table").html(tableData);
                    console.log(specCodes)
                }
            });
        }


        function saveData(i) {
            //alert("success");
            sessionStorage.setItem("specVersion", specVersion[i]);
            sessionStorage.setItem("specCode", specCodes[i]);
        }
    </script>
{% endblock %}