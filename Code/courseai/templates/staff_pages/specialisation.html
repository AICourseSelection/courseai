{% extends 'staff_pages/staff_base.html' %}
{% block content %}
    <section id="bc" class="mt-3">
        <div class="container">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{% url 'index' %}">
                            <i class="fa fa-home"></i> Home </a>
                    </li>
                    <li class="breadcrumb-item active">{{ bc_param }}</li>
                </ol>
            </nav>
        </div>
    </section>
    <div class="container text-center">
        <h1 class="display-4 mb-4">
            <strong>Search Specialisation</strong>
        </h1>

        <div class="form-row">
            <div class="col-md-4 mb-3">

            </div>

            <div class="col-md-4 mb-3">
                <label class="sr-only">Year</label>

            </div>
            <div class="col-md-4 mb-3">

            </div>

        </div>
    </div>
    <div class="container">
        <div class="row justify-content-md-center">
            <div class="col col-lg-4">
                <input type="text" id="search" name="search" class="form-control" placeholder="Specialisation Code"
                       onkeydown="if(event.keyCode==13) {showspecs()}">
            </div>
            <div class="col-md-auto">
                <select id="year" name='year' class="form-control">
                    {% for year in years %}
                        {% if year == year_now %}
                            <option selected value="{{ year }}">{{ year }}</option>
                        {% else %}
                            <option value="{{ year }}">{{ year }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            <div class="col col-lg-2">
                <button onclick="showspecs()" class="btn btn-outline-primary">Search</button>
            </div>
        </div>
    </div>
    <div style="width: 100%; text-align: center">
        <div>&nbsp</div>
        <div class="table-responsive">
            <table id="Table" class="table table-hover" style="width: 45%; margin: auto">

            </table>
        </div>
    </div>
    <script>
        function str_substr(start, end, str) {
            content = [];
            string="";
            try {
                temp = str.split(start, 2);
                content = temp[1].split(end, 2);

            } catch (e) {
                console.log(e.name + ":" + e.message);
            }
            if (content == undefined) {
                return null;
            }
            description=content[0].split(" ");
            for (let i=0;i<7;i++){
                string=string+" "+description[i];
            }
            return string;
        }

        let level = "undergraduate";
        let description = "";
        var specsCodes = [];
        var specsVersions = [];


        function showspecs() {
            specsCodes = [];
            specsVersions = [];
            specLevel=[];
            let specs = document.getElementById("search").value;
            //let level = document.getElementById("level").value;
            let year = document.getElementById("year").value;
           let tableData = "<thead class = \"thead-light\">\n" +
                "                    <tr>\n" +
                "                      <th scope=\"col\" width=\"30%\">Specialisation Code</th>\n" +
                "                      <th scope=\"col\" width=\"70%\">Specialisation Title</th>\n" +
                "                    </tr>\n" +
                "                  </thead>";
            tableData += "<tbody>\n" +
                "    <tr>";
            const specDescription = [];
            const specsTitle = [];
            $.ajax({
                url: '../search/specs',
                data: {"query": specs, "level": level},
                success: function (data) {
                    console.log(data.responses)
                    let i;
                    for (i in data.responses) {
                        if (data.responses[i].versions[year] != undefined) {
                            if (data.responses[i].versions[year].description != undefined) {
                                specsCodes.push(data.responses[i].code);
                                specLevel.push(data.responses[i].level);
                                specsVersions.push(JSON.stringify(data.responses[i].versions));
                                description = JSON.stringify(data.responses[i].versions[year].description);
                                description = str_substr("\"", ".", description);
                                specDescription.push(description + "......");
                                specsTitle.push(JSON.stringify(data.responses[i].versions[year].title).replace(/\"/g, ""));
                            }
                        }
                    }
                    if (specsCodes.length == 0) {
                        tableData="<strong>No such spec</strong><br /> "
                         $("#Table").html(tableData);
                        return;
                    } else {
                        for (i = 0; i < specsCodes.length; i++) {
                            for (let j = 0; j < 2; j++) {

                                    if (j == 0) {
                                        tableData += "<td style=\"text-align:center\">" +
                                            "<a href=\"specialisation_detail?code=" + specsCodes[i ] + "&year=" + year + "&level=" + specLevel[i] + "\" >" +
                                            specsCodes[i ] +
                                            "</a>" +
                                            "</td>";
                                    } else if (j == 1) {
                                        tableData += "<td style=\"text-align:left\">" +
                                            "<a href=\"specialisation_detail?code=" + specsCodes[i] + "&year=" + year + "&level=" + specLevel[i] + "\" >" +
                                            specsTitle[i] +
                                            "</a>" +
                                            "</td>";
                                    }

                            }
                            tableData += "</tr>" + "<tr>";
                        }
                    }
                    $("#Table").html(tableData);
                }
            });
        }



    </script>
{% endblock %}