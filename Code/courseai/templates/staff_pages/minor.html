{% extends 'staff_pages/staff_base.html' %}
{% block content %}
    <section id="bc" class="mt-3">
    <div class="container">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
              <a href="{% url 'index' %}">
            <i class="fa fa-home"></i> Home </a>
          </li>
            <li class="breadcrumb-item active">{{ bc_param }}</li>
        </ol>
      </nav>
    </div>
  </section>
     <div style="margin-top: 15px; flex-wrap: nowrap" >
    <div style="width: 100%; text-align: center">
<table class="table">
    <tr>
        <td>
        <input type="text" id = "search" name="minorName" required placeholder="Search Mms"
               autocomplete="off" data-toggle="popover" style="width:30%">
                <button onclick="showMinors()" class="btn btn-primary btn-lg">Show Minors</button>
            <div>&nbsp</div>
        </td>
        </tr>
    <tr>
        <td>
        <label>Academic year: </label>
              <select id="year" class="btn-group">
    <option value="2014" selected="selected">2014</option>
    <option value="2015">2015</option>
    <option value="2016">2016</option>
    <option value="2017">2017</option>
    <option value="2018">2018</option>
    <option value="2019">2019</option>
    <option value="2020">2020</option>
</select>
        </td>
    </tr>
    </table>
        <div>&nbsp</div>
        <div class="table-responsive">
            <table class="table" style="width: 50%; margin: auto">
                    <tbody id="Table">
                    </tbody>
                </table>
        </div>
    </div>
</div>
    <script>
    function str_substr(start, end, str) {
       try{
            temp = str.split(start, 2);
            content = temp[1].split(end, 2);
        }
        catch (e) {
            console.log(e.name + ":" + e.message);
        }
        if(content==undefined){
            return null;
        }
        return content[0];
    }
        let level="undergraduate";
        let description="";
    var minorsVersion = [];
    var minorsCodes = [];
    function showMinors() {
        let minors = document.getElementById("search").value;
        //let level = document.getElementById("level").value;
        let year= document.getElementById("year").value;
        let tableData = "<tr>";
        let tempRequirement = "";
        const minorDescription = [];
        const minorsRequirements = [];
        const minorsTitle = [];
        $.ajax({
            url: '../search/minors',
            data: {"query": minors, "level": level},
            success: function (data) {
                for (i in data.responses) {
                    minorsCodes.push(data.responses[i].code);
                    minorsVersion.push(JSON.stringify(data.responses[i].versions));
                    if (data.responses[i].versions[year]==undefined){
                        minorDescription.push("No "+year+" information.");
                        minorsRequirements.push("");
                        minorsTitle.push("");
                    }
                    else{
                    description=JSON.stringify(data.responses[i].versions[year].description);
                    description=str_substr("\"",".",description);
                    minorDescription.push(description+"......");
                    tempRequirement = JSON.stringify(data.responses[i].versions[year].requirements);
                    tempRequirement = replaceString(tempRequirement);
                    tempRequirement="title"+str_substr("title","title",tempRequirement)+"...";
                    minorsRequirements.push(tempRequirement);
                    minorsTitle.push(JSON.stringify(data.responses[i].versions[year].title).replace(/\"/g,""));}
                }
                if (minorsCodes.length == 0) {
                    tableData += "<th>" + "No such minor" + "</th>" + "</tr>";
                } else {
                    for (var i = 0; i < minorsCodes.length + 1; i++) {
                        for (var j = 0; j < 4; j++) {
                            if (i == 0) {
                                if (j == 0) {
                                    tableData += "<th>" + "minor Code" + "</th>";
                                } else if (j == 1) {
                                    tableData += "<th>" + "minor Title" + "</th>";
                                } else if (j == 2) {
                                    tableData += "<th>" + "minor Requrirement" + "</th>";
                                } else if (j == 3) {
                                    tableData += "<th>" + "minor Description" + "</th>";
                                }
                            } else {
                                if (j == 0) {
                                    tableData += "<td>" +
                                        "<a href=\"minor_detail?code=" + minorsCodes[i - 1] + "&year=" + year + "\" onClick=\"saveData('" + (i - 1) + "')\">" +
                                        minorsCodes[i - 1] +
                                        "</a>" +
                                        "</td>";
                                } else if (j == 3) {
                                    tableData += "<td>" + minorDescription[i - 1] + "</td>";
                                } else if (j == 2) {
                                    tableData += "<td>" + minorsRequirements[i - 1] + "</td>";
                                } else if (j == 1) {
                                    tableData += "<td>" + minorsTitle[i - 1] + "</td>";
                                }
                            }
                        }
                        tableData += "</tr>" + "<tr>";
                    }
                }
                $("#Table").html(tableData);
            }
        });
    }
        function replaceString(string) {
        if (string == undefined) {
            return "";
        }
        string = string.replace(/{|}|\"x_from_here\":|type:minimum:/g, "");
        string = string.replace(/\"courses\"/g, "");
        string = string.replace(/\[:|\[|\]|\"/g, "");
        string = string.replace(/,code/g, "<br>code");
        //string=string.replace(/,"units":/g,"<br>\"units\":");
        return string;
    }

    function saveData(i) {
        //alert("success");
        sessionStorage.setItem("minorVersion", minorsVersion[i]);
        sessionStorage.setItem("minorCode", minorsCodes[i]);
    }
    </script>
{% endblock %}