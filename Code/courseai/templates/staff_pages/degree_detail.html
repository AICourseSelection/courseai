{% extends 'staff_pages/staff_base.html' %}

{% block content %}
    <section id="bc" class="mt-3">
        <div class="container">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{% url 'index' %}">
                            <i class="fa fa-home"></i> Home </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="{% url 'degree' %}"> Degree </a>
                    </li>
                    <li class="breadcrumb-item active">{{ bc_param }}</li>
                </ol>
            </nav>
        </div>
    </section>

    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" caller-id="" role="dialog"
         aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body alert-danger text-center">
                    <h4><strong>Warning! Delete action is permanent! You will back to the search page after clicking the
                        delete button.</strong></h4>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>

                    <button type="button" id="delete" class="btn btn-danger" data-dismiss="modal"
                            id="confirmDeleteButtonModal" onclick=deleteData()>
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmSaveModal" tabindex="-1" caller-id="" role="dialog"
         aria-labelledby="confirmSaveModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body alert-success text-center">
                    <h4><strong>Are you Sure?</strong></h4>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>

                    <button type="button" id="save" class="btn btn-success" data-dismiss="modal"
                            id="confirmSaveButtonModal" onclick=saveData()>
                        Save
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container text-center">
        <div id="alert">
        </div>
        <h1 id="pageTitle"></h1>

    </div>
    <div class="container" id="deleteMode">
        <button id="btnEdit" class="btn btn-outline-info float-left">Edit</button>
        <button id="btnDelete" class="btn btn-outline-danger float-right" data-toggle="modal" data-target="#confirmDeleteModal">Delete</button>
    </div>
    <div class="container" id="editMode" style="display: none">
        <button id="btnEditCancel" class="btn btn-outline-info float-left">Cancel</button>
        <button id="btnSave" class="btn btn-outline-success float-right" data-toggle="modal" data-target="#confirmSaveModal">Save</button>
    </div>

    <div>&nbsp</div>
    <div>&nbsp</div>

    <div class="container h-100" id="queryContainer">
        <table class="table table-striped">
            <tr>
                <td style="text-align: right; width: 20%">Code:</td>
                <td style="text-align: left" id="code_q"></td>
            </tr>
            <tr>
                <td style="text-align: right; width: 20%">Year:</td>
                <td style="text-align: left" id="year_q"></td>
            </tr>
            <tr>
                <td style="text-align: right; width: 20%">Title:</td>
                <td style="text-align: left" id="title_q">
                </td>
            </tr>
            <tr>
                <td style="text-align: right; width: 20%">Units:</td>
                <td id="Units_q" style="text-align: left">
                </td>
            </tr>
            <tr>
                <td style="text-align: right; width: 20%">Compulsory Course:</td>
                <td id="compulsory_q" style="text-align: left">
                </td>
            </tr>
            <tr>
                <td style="text-align: right; width: 20%">Study Plan:</td>
                <td id="plan_q" style="text-align: left">
                    <table id="planTable_q" class="table table-hover" style="width: 100%; margin: auto">

                    </table>
                </td>
            </tr>
        </table>

    </div>

    <div class="container h-100" id="editContainer" style="display: none">
        <table class="table table-striped">
            <tr>
                <td style="text-align: right; width: 20%">Code:</td>
                <td style="text-align: left" id="code"></td>
            </tr>
            <tr>
                <td style="text-align: right; width: 20%">Year:</td>
                <td style="text-align: left" id="year"></td>
            </tr>
            <tr>
                <td style="text-align: right; width: 20%">Title:</td>
                <td style="text-align: left" id="title">
                </td>
            </tr>
            <tr>
                <td style="text-align: right; width: 20%">Units:</td>
                <td id="Units" style="text-align: left">
                </td>
            </tr>
            <tr>
                <td style="text-align: right; width: 20%">Compulsory Course:</td>
                <td id="compulsory" style="text-align: left">
                </td>
            </tr>
            {#            <tr>#}
            {#                <td style="text-align: right; width: 20%">Specialisation:</td>#}
            {#                <td id="specialisation" style="text-align: left">#}
            {#                </td>#}
            {#            </tr>#}
            <tr>
                <td style="text-align: right; width: 20%">Study Plan:</td>
                <td id="plan" style="text-align: left">
                    <table id="planTable" class="table table-hover" style="width: 100%; margin: auto">

                    </table>
                </td>
            </tr>
        </table>

    </div>

    <script src="http://code.jquery.com/jquery-1.6.2.min.js"></script>
    <script>
        function getQueryString(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
            var r = location.search.substr(1).match(reg);
            if (r != null) return (r[2]);
            return null;
        }

        var versions;
        var codeS = getQueryString("code");
        var yearS = getQueryString("year");
        var titleS = getQueryString("title");
        titleS = titleS.replace(/%20/g, " ");
        pageTitleS = titleS + " (" + yearS + ")";
        pageTitle.innerHTML = pageTitleS;
        document.getElementById('code').innerText = codeS;
        document.getElementById('year').innerText = yearS;
        document.getElementById('title').innerText = titleS;
        $('#code_q').text(codeS);
        $('#year_q').text(yearS);
        $('#title_q').text(titleS);
        var courseUrl = window.location.origin + "/staff" + "/course_detail?"
        var compulsory = "";
        let compulsory_q = "";
        var compulsoryList = [];
        var specList = [];
        var compulsoryTable = document.getElementById("compulsory");
        var spec = "";
        let specTable = document.getElementById("specialisation");
        var planList = [];
        let planTable = document.getElementById("planTable");

        let planString = "<tbody>\n" +
            "    <tr>";
        let planString_q = "<tbody>\n" +
            "    <tr>";


        $.ajax({
            url: '../degree/degreeplan',
            data: {"degree_code": codeS, "year": yearS},
            method: 'GET',
            success: function (data) {
                console.log("degreeplan success");
                for (let i = 0; i < data.response.length; i++) {
                    //console.log(data.response)
                    for (let j = 0; j < data.response[i].length; j++) {
                        if(data.response[i][j].code.toString().length==9){
                            planList.push(data.response[i][j].code.toString().replace(/\s*/g, ""));
                        }
                        else{
                        planList.push(data.response[i][j].code.toString());
                        }
                    }
                }
                let yearLength = planList.length / 8;
                let length = 0;
                //console.log(yearLength);
                for (let i = 0; i < yearLength; i++) {
                    planString += "<td>" + "Year" + (i + 1) + "</td>";
                    planString_q += "<td>" + "Year" + (i + 1) + "</td>";
                    for (let j = 0; j < 4; j++) {
                        if (planList[length].length == 8) {
                            let link = courseUrl + "code=" + planList[length] + "&year=" + yearS;
                            planString += "<td>" + "<input type=\"text\" id=\"plan" + length + "\"value=\"" + planList[length] + "\" class=\"form-control\" >" + "</td>";
                            planString_q += "<td>" + "<a href=\"" + link + "\" target=\"_Blank\">" + planList[length] + "</a>" + "<br>" + "</td>";
                        } else {
                            planString += "<td>" + "<input type=\"text\" id=\"plan" + length + "\"value=\"" + planList[length] + "\" class=\"form-control\" >" + "</td>";
                            planString_q += "<td>" + planList[length] + "<br>" + "</td>";
                        }
                        length++;
                    }
                    planString += "</tr>" + "<tr>";
                    planString += "<td>" + "" + "</td>";
                    planString_q += "</tr>" + "<tr>";
                    planString_q += "<td>" + "" + "</td>";
                    for (let j = 0; j < 4; j++) {
                        if (planList[length].length == 8) {
                            let link = courseUrl + "code=" + planList[length] + "&year=" + yearS;
                            planString += "<td>" + "<input type=\"text\" id=\"plan" + length + "\"value=\"" + planList[length] + "\" class=\"form-control\" >" + "</td>";
                            planString_q += "<td>" + "<a href=\"" + link + "\" target=\"_Blank\">" + planList[length] + "</a>" + "<br>" + "</td>";
                        } else {
                            planString += "<td>" + "<input type=\"text\" id=\"plan" + length + "\"value=\"" + planList[length] + "\" class=\"form-control\" >" + "</td>";
                            planString_q += "<td>" + planList[length] + "<br>" + "</td>";

                        }
                        length++;
                    }
                    planString += "</tr>" + "<tr>";
                    planString_q += "</tr>" + "<tr>";
                }
                planString += "</tbody>";
                planString_q += "</tbody>";
                planTable.innerHTML = planString;
                $('#planTable_q').html(planString_q);
            }
        });
        $.ajax({
            url: '../degree/degreereqs',
            data: {"query": codeS + "-" + yearS},
            success: function (data) {
                versions = data;
                console.log("degreereqs success");
                document.getElementById('Units').innerText = data.units;
                $('#Units_q').text(data.units);
                if (data.required.compulsory_courses != undefined) {
                    for (let i = 0; i < data.required.compulsory_courses.length; i++) {
                        compulsoryList.push(data.required.compulsory_courses[i].toString().replace(/\s*/g, ""))
                    }
                }
                {% comment %}for (let i = 0; i < data.required["one_from_m/m/s"].length; i++) {
                    let specArray = data.required["one_from_m/m/s"][i].toString().split(",");
                    for (let j = 0; j < specArray.length; j++) {
                        specList.push(specArray[j].toString().replace(/\s*/g, ""));
                    }
                }{% endcomment %}
                {#<textarea rows="3" class="form-control" id="outcome" placeholder="Learning Outcome" name="outcome" ></textarea>#}
                compulsory += "<textarea cols = \"20\" rows=\"" + compulsoryList.length + "\" id=\"compulsories\" >";
                for (let i = 0; i < compulsoryList.length; i++) {
                    let link = courseUrl + "code=" + compulsoryList[i] + "&year=" + yearS;
                    if(i == compulsoryList.length - 1){
                        compulsory += compulsoryList[i];
                    }
                    else {
                        compulsory += compulsoryList[i] + "&#10";
                    }
                    {#compulsory += "<input type=\"text\" id=\"compulsory" + i + "\"value=\"" + compulsoryList[i] + "\">" + "<a href =" + link + ">  Course detail<a>" + "<br>";#}
                    compulsory_q += "<a href =" + link + ">" + compulsoryList[i] +  "<a>" + "<br>";
                }
                compulsory += "</textarea>";
                {% comment %}for (let i = 0; i < specList.length; i++) {
                    spec += "<input type=\"text\" id=\"spec" + i + "\"value=\"" + specList[i] + "\">" + "<br>";
                }
                specTable.innerHTML = spec;{% endcomment %}
                compulsoryTable.innerHTML = compulsory;
                $('#compulsory_q').html(compulsory_q);

                $(document).ready(function () {
                    $('#btnEdit').click(function () {
                        $('#deleteMode').hide();
                        $('#editMode').show();
                        $('#queryContainer').hide();
                        $('#editContainer').show();
                    });
                    $('#btnEditCancel').click(function () {
                        $('#deleteMode').show();
                        $('#editMode').hide();
                        $('#queryContainer').show();
                        $('#editContainer').hide();
                    });
                });
            }
        });

        function saveData() {
                                    {#for (let i = 0; i < compulsoryList.length; i++) {#}
                                    {#    compulsoryList[i]=document.getElementById("compulsory" + i).value.toString();#}
                                    {#}#}
                                     for (let i = 0; i < planList.length; i++) {
                                        planList[i]=document.getElementById("plan" + i).value.toString();
                                    }

                                    let compulsories = $('#compulsories').text().split("\n");

                                    let postPlan= JSON.stringify(planList);
                                    {#let postCompulsory= JSON.stringify(compulsoryList);#}
                                    let postCompulsory= JSON.stringify(compulsories);
                                    $.ajax({
                                        url: '../degree/saveDegree',
                                        data: {"code": codeS, "compulsoryList":postCompulsory, "planList":postPlan,"year": yearS},
                                        dataType:"json",
                                        success: function (data) {
                                            console.log(data)
                                            $('#alert').html('Save success').addClass('alert-success').show().delay(10000).fadeOut();
                                        }

                                    });
        }

        function deleteData() {
            console.log(codeS + yearS);
            $.ajax({
                url: '../degree/delete',
                data: {"code": codeS, "type": "degree", "year": yearS},
                success: function (data) {
                    console.log(data)
                }

            });
            window.location.href='degree';
        }
    </script>

{% endblock %}